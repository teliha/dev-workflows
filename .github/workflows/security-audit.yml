name: Security Audit

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  id-token: write

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Run Claude Code Audit
        id: audit
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowed-tools "Bash(gh issue create:*),Bash(gh issue list:*)"'
          prompt: |
            /audit

            Please perform a comprehensive security audit. The audit command will automatically detect the project type.

            Generate a detailed audit report and save it to `audit-report-$(date +%Y%m%d).md`.

            After completing the audit:
            1. If you find any CRITICAL severity issues, create a GitHub issue using the `gh` CLI:
               - Title: "ðŸš¨ CRITICAL Security Issue - Audit YYYY-MM-DD"
               - Body should include:
                 - Summary of critical findings
                 - Link to this workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                 - Next steps for remediation
               - Labels: security, critical, audit
               - Example command: `gh issue create --title "..." --body "..." --label security,critical,audit`

            2. The GITHUB_TOKEN is available in the environment for gh CLI authentication.
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-${{ github.run_number }}
          path: |
            audit-report-*.md
            audits/**/*.md
          retention-days: 90
