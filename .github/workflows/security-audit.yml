name: Security Audit

on:
  workflow_call:
    inputs:
      create_issue_on_critical:
        description: "Create issue if critical findings are found"
        required: false
        type: boolean
        default: true
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
      GITHUB_TOKEN:
        required: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  id-token: write

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Run Claude Code Audit
        id: audit
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            /audit

            Please perform a comprehensive security audit. The audit command will automatically detect the project type.

            Generate a detailed audit report and save it to `audit-report-$(date +%Y%m%d).md`.

            If you find any CRITICAL severity issues, ensure they are clearly marked in the report.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse audit results for critical issues
        id: parse_audit
        if: always()
        run: |
          AUDIT_FILE=$(find . -name "audit-report-*.md" -o -name "*audit*.md" | head -1)

          if [ -z "$AUDIT_FILE" ]; then
            echo "No audit report found"
            echo "has_critical=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found audit file: $AUDIT_FILE"

          if grep -qi "CRITICAL" "$AUDIT_FILE" || grep -qi "\[CRITICAL\]" "$AUDIT_FILE"; then
            echo "has_critical=true" >> $GITHUB_OUTPUT

            CRITICAL_SECTION=$(awk '/CRITICAL/,/(HIGH|MEDIUM|^---|^##)/' "$AUDIT_FILE" | head -100)

            echo "critical_findings<<EOF" >> $GITHUB_OUTPUT
            echo "$CRITICAL_SECTION" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "Critical issues found!"
          else
            echo "has_critical=false" >> $GITHUB_OUTPUT
            echo "No critical issues found"
          fi

      - name: Create GitHub Issue for Critical Findings
        if: inputs.create_issue_on_critical && steps.parse_audit.outputs.has_critical == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const criticalFindings = `${{ steps.parse_audit.outputs.critical_findings }}`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const issueBody = `## üö® Critical Security Issue Detected

            The automated security audit has detected a **CRITICAL** severity issue that requires immediate attention.

            ### Critical Findings

            ${criticalFindings}

            ### Details

            - **Audit Run**: [View workflow run](${runUrl})
            - **Date**: ${new Date().toISOString().split('T')[0]}
            - **Trigger**: ${context.eventName}

            ### Next Steps

            1. ‚ö†Ô∏è **Review the finding immediately**
            2. üîç **Analyze the vulnerable code path**
            3. üõ†Ô∏è **Implement the recommended fix**
            4. ‚úÖ **Add test cases to prevent regression**
            5. üîÑ **Re-run the audit to verify the fix**

            ### Audit Report

            Download the full audit report from the [workflow artifacts](${runUrl}).

            ---

            ü§ñ *Automatically generated by Security Audit workflow*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® CRITICAL Security Issue - Audit ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['security', 'critical', 'audit']
            });

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-${{ github.run_number }}
          path: |
            audit-report-*.md
            audits/**/*.md
          retention-days: 90
