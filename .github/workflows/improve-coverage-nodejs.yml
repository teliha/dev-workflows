name: Improve Test Coverage (Node.js/Next.js)

on:
  workflow_call:
    inputs:
      node_version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "20"
      target_coverage_increase:
        description: "Target coverage increase percentage"
        required: false
        type: string
        default: "5"
      base_branch:
        description: "Base branch for PR"
        required: false
        type: string
        default: "main"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
      GITHUB_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  improve-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Setup git identity
        run: |
          git config --global user.email "claude[bot]@users.noreply.github.com"
          git config --global user.name "claude[bot]"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get current coverage
        id: current_coverage
        run: |
          COVERAGE_OUTPUT=$(npm run test:coverage 2>&1 || npm test -- --coverage 2>&1 || echo "Coverage failed")
          echo "coverage_report<<EOF" >> $GITHUB_OUTPUT
          echo "$COVERAGE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          COVERAGE_PCT=$(echo "$COVERAGE_OUTPUT" | grep -oP 'All files.*?(\d+\.\d+)' | grep -oP '\d+\.\d+' | head -1 || echo "0")
          echo "coverage_pct=$COVERAGE_PCT" >> $GITHUB_OUTPUT

      - name: Create improvement branch
        id: branch
        run: |
          BRANCH_NAME="claude-improve-coverage-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Improve coverage with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            /improve-coverage

            ## Project Type

            This is a Node.js/Next.js project.

            ## Current Test Coverage

            ```
            ${{ steps.current_coverage.outputs.coverage_report }}
            ```

            Current overall coverage: ${{ steps.current_coverage.outputs.coverage_pct }}%

            ## Task

            Analyze the current test coverage and add new test cases to improve it.

            Target: Increase coverage by at least ${{ inputs.target_coverage_increase }}%

            After adding tests:
            1. Verify all tests pass: `npm test`
            2. Check coverage improvement: `npm run test:coverage` or `npm test -- --coverage`
            3. Commit changes: `git add . && git commit -m "test: improve coverage"`
            4. Push: `git push origin ${{ steps.branch.outputs.branch_name }}`
            5. Create PR using `gh pr create` targeting `${{ inputs.base_branch }}`

      - name: Get new coverage
        if: success()
        id: new_coverage
        run: |
          COVERAGE_OUTPUT=$(npm run test:coverage 2>&1 || npm test -- --coverage 2>&1 || echo "Coverage check failed")
          echo "new_coverage_report<<EOF" >> $GITHUB_OUTPUT
          echo "$COVERAGE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          NEW_COVERAGE_PCT=$(echo "$COVERAGE_OUTPUT" | grep -oP 'All files.*?(\d+\.\d+)' | grep -oP '\d+\.\d+' | head -1 || echo "0")
          echo "new_coverage_pct=$NEW_COVERAGE_PCT" >> $GITHUB_OUTPUT

      - name: Create summary issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Auto Coverage Improvement Failed (Node.js)',
              body: `## Coverage Improvement Attempt Failed

              **Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              **Current Coverage**: ${{ steps.current_coverage.outputs.coverage_pct }}%

              Please check the logs for details.`,
              labels: ['automated', 'testing', 'needs-review']
            });
